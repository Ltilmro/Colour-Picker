В принципе работает, но так как реализация далека от идеала, буду дорабатывать.
Залью сюда на случай если что-то сломаю